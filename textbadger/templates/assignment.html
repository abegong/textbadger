{% extends "base/document-control.html" %}
{% load tb_app_tags %}

{% block start_scripts %}
<script src="{{ STATIC_URL }}jquery.tmpl.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}underscore-min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}knockout-1.2.1.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}informal/informalModel.js" type="text/javascript"></script>

<script type="text/javascript">
var finalInit = function(){
    //Add hidden csrf token and other hidden fields

    //Add the "submit" button.
    $('<div class="questionBox"><div class="questionContent" style="text-align:right"><a class="btn btn-inverse">Submit</a></div></div>')
        .appendTo("#codebook")
        .click(function(){
//            console.log(DocManager.seq_list);
//            console.log(DocManager.seq_index);
//            console.log(DocManager.doc_index);
            $.post(
                "/ajax/submit-batch-code/",
                $('#codebook-form').serialize(),
                function(result){
                    if( result.status == "success" ){
                        //Clear codebook answers
                        $form = $("#codebook-form");
                        $form.find('input:text, input:password, input:file, select, textarea').val('');
                        $form.find('input:radio, input:checkbox')
                             .removeAttr('checked').removeAttr('selected');
                        
                        //Load the next document
                        DocManager.loadNextDoc();
                    }else{
                        alert( result.msg );
                    }
                }
            );
        });

}
var launchInformalViewer = function( codebook_json ){
    codebookModel.loadQuestions(codebook_json);
    
    //Load the template and knockout model dynamically.
    $.get("{{ STATIC_URL }}informal/_informalTemplateKO.htm", function(template){
        $("body").append(template);
        ko.applyBindings(codebookModel);
        codebookModel.addStylesToCodebook();
        finalInit();
    }, "text");

};
	
	
$(function(){
    var seq_list = {{seq_list}};
    
    //Highlight "my-account" in nav bar
    $('a[href*="/my-account/"]').parent().addClass("active");

    //Load collection
    DocManager.initialize("{{batch.profile.collection_id}}","{{csrf_token}}", seq_list);

    //Load codebook
	$.post("/ajax/get-codebook/",
        {'id': "{{ batch.profile.codebook_id }}", 'csrfmiddlewaretoken': '{{ csrf_token }}' },
        function(response){
            //! Need error checking for failed responses.
            launchInformalViewer(response.codebook.questions);       
        }
    );
});
</script>
{% endblock %}

{% block breadcrumbs %}
<div class="container">
<ul class="breadcrumb">
  <li>
    <a href="/my-account/#assignments">Assignments</a>
    <span class="divider">/</span>
  </li>
  <li>
    <a href="#">{{ batch.profile.name }}</a></span>
  </li>
  <li>
    <span class="divider"> :: </span>
    <a href="/batch/{{ batch|mongo_id }}/">Go to batch page</a></span>
  </li>
</ul>
</div>
{% endblock %}

{% block document %}
--- Document ---
{% endblock %}

{% block control %}
<form id="codebook-form">
    <div id="codebook" data-bind="template: { name: 'question-template', foreach: questions }" tb-codebook-mode="viewer"></div>
    {% csrf_token %}
    <input id='batch-id-hidden' type='hidden' name='batch_id' value='{{ batch|mongo_id }}'></input>
    <input id='doc-index-hidden' type='hidden' name='doc_index' value='0'></input>
    <br/>
</form>

{% endblock %}

