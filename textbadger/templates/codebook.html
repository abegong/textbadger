{% extends "base/document-control.html" %}
{% load tb_app_tags %}

{% block start_scripts %}
<script src="{{ STATIC_URL }}jquery.tmpl.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}underscore-min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}knockout-1.2.1.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}informal/informalModel.js" type="text/javascript"></script>

<script type="text/javascript">
var launchInformalEditor = function( codebook_json ){

  //Create the default question

    codebookModel.questions([
        new cbQuestion("Static text", "", {} ),
        new cbQuestion("Multiple choice", "", {} ),
        new cbQuestion("Check all that apply", "", {} ),
        new cbQuestion("Two-way scale", "", {} ),
        new cbQuestion("Radio matrix", "", {} ),
        new cbQuestion("Checkbox matrix", "", {} ),
        new cbQuestion("Two-way matrix", "", {} ),
        new cbQuestion("Text box", "", {} ),
        new cbQuestion("Short essay", "", {} ),
        new cbQuestion("Text matrix", "", {} )
    ]);
    codebookModel.loadQuestions(codebook_json);
    
    //Load the template and knockout model dynamically.
    $.get("/static/informal/_informalTemplateKO.htm", function(template){
        $("body").append(template);
        ko.applyBindings(codebookModel);
        codebookModel.addStylesToCodebook();
        codebookModel.attachControlsToQuestion(0);
    }, "text");
};
	
var codebook_id = "{{codebook|mongo_id}}";

$(function(){
    //Highlight "my-account" in nav bar
    $('a[href*="/shared-resources/"]').parent().addClass("active");

    //Activate button controls
	$('#add_control').click( function(){ codebookModel.addQuestion(); } );
	$('#del_control').click( function(){ codebookModel.delQuestion(); } );
	$('#up_control').click( function(){ codebookModel.moveQuestionUp(); } );
	$('#down_control').click( function(){ codebookModel.moveQuestionDown(); } );

/*
	//! Didn't work
    $('#export-json').click( function(){
        //! Can't get this to work.
        //! Better to just rewrite as real method.
        var json = codebookModel.getCodebookJson();
        window.open('/ajax/export-codebook/?'+JSON.stringify(json),"Json Download", "resizable=0,status=0,toolbar=0,width=600px,height=300px");
    });
*/
/*
	//! Not used
    $('#export-html').click( function(){
        var new_window = window.open('about:blank',"Html Download", "resizable=0,status=0,toolbar=0,width=600px,height=300px");
        new_window.document.write($("#codebook").html());
    });
*/

	//Load the codebook on initialization.
	$.post("/ajax/get-codebook/",
        {'id': codebook_id, 'csrfmiddlewaretoken': '{{ csrf_token }}' },
        function(response){
            //! Need error checking for failed responses.
            launchInformalEditor(response.codebook.questions);
        }
    );

	//AJAX to save the codebook
    $("#save-codebook").click(function(){
	    $.post(
            "/ajax/save-codebook/",
            {
                'parent_id': codebook_id,
                'questions':codebookModel.getCodebookJson(),
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            function(response){                
                //! Need error checking for failed responses.
                location.href = '/codebook/'+response._id;
            }
        );
    });
});
</script>
{% endblock %}

{% block breadcrumbs %}
<div class="container">
<ul class="breadcrumb">
  <li>
    <a href="/shared-resources/#codebooks">Codebooks</a> <span class="divider">/</span>
  </li>
  <li>
    <a href="#">{{codebook.name}} ({{codebook.version}})</a></span>
  </li>
</ul>
</div>
{% endblock %}

{% block doc_classes %}span3 well offset3{% endblock %}

{% block title %}
{% endblock %}

{% block document %}
<!-- --- Codebook --- -->
<!--
<div id="loading-msg">
    <img class="tb-loading" src="{{ STATIC_URL }}ajax-loader.gif"></img>
    <p>Loading codebook...</p>
</div>
-->
<div id="codebook" data-bind="template: { name: 'question-template', foreach: questions }" tb-codebook-mode="editor"></div>
{% endblock %}

{% block control %}

<button id="save-codebook" class="btn btn-primary rightside" type="submit">Save changes</button>
<h3>{{codebook.name}} ({{codebook.version}})</h3>
<hr />
<a class="btn btn-primary open-modal rightside">Edit codebook info</a>
{% include "forms/edit-codebook.htm" %}
<h4>Codebook</h4>
<strong>Name</strong>
<p>{{ codebook.name }}</p>

<strong>Description</strong>
<p>{{ codebook.description }}</p>

<strong>Version</strong>
<p>{{ codebook.version }}</p>




<!--
      <dl class="dl-horizontal">
        <dt>version</dt><dd>{{ codebook.version }}&nbsp;</dd>
        <dt>previous version</dt><dd>{{ codebook.parent }}&nbsp;</dd>
        <dt>has </dt><dd>Gong&nbsp;</dd>
        <dt>email</dt><dd>agong@umich.edu&nbsp;</dd>
           </dl>
-->
   

<!--
      <hr/>
      <div id="impexpControls">
          <a class="btn" id="export-json"><i class="icon-download"></i> Export Json</a>
          <a class="btn" id="export-html"><i class="icon-download"></i> Export HTML</a>
      </div>
-->
     <hr />
    <h4>Question</h4>
  
        <div id="questionControls"></div>
        <hr/>
        <div id="sequenceControls" style="text-align:center">
            <button id="add_control"><span class="control icon-plus"></span></button>
            <button id="del_control"><span class="control icon-minus"></span></button>
            <button id="up_control"><span class="control icon-arrow-up"></span></button>
            <button id="down_control"><span class="control icon-arrow-down"></span></button>
        </div>
   </div>
  </div>
</div>
{% endblock %}

