{% extends "base/document-control.html" %}
{% load tb_app_tags %}

{% block start_scripts %}
<script src="{{ STATIC_URL }}jquery.tmpl.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}underscore-min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}knockout-1.2.1.js" type="text/javascript"></script>

<script src="{{ STATIC_URL }}informal/informalScripts.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}informal/informalModel.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}informal/informalEditor.js" type="text/javascript"></script>
<link href="{{ STATIC_URL }}informal/informal-styles.css" rel="stylesheet">

<script type="text/javascript">
var codebook_id = "{{codebook|mongo_id}}";

$(function(){
    //Highlight "my-account" in nav bar
    $('a[href*="/shared-resources/"]').parent().addClass("active");

    //Activate button controls
	$('#add_control').click( function(){ codebookModel.addQuestion(); } );
	$('#del_control').click( function(){ codebookModel.delQuestion(); } );
	$('#up_control').click( function(){ codebookModel.moveQuestionUp(); } );
	$('#down_control').click( function(){ codebookModel.moveQuestionDown(); } );

/*
    $('#export-json').click( function(){
        //! Can't get this to work.
        //! Better to just rewrite as real method.
        var json = codebookModel.getCodebookJson();
        window.open('/ajax/export-codebook/?'+JSON.stringify(json),"Json Download", "resizable=0,status=0,toolbar=0,width=600px,height=300px");
    });
*/
    $('#export-html').click( function(){
        var new_window = window.open('about:blank',"Html Download", "resizable=0,status=0,toolbar=0,width=600px,height=300px");
        new_window.document.write($("#codebook").html());
    });

	$.post("/ajax/get-codebook/",
        {'id': codebook_id, 'csrfmiddlewaretoken': '{{ csrf_token }}' },
        function(response){
            //! Need error checking for failed responses.
            launchInformalEditor(response.codebook.questions);
        }
    );

    $("#save-codebook").click(function(){
	    $.post(
            "/ajax/save-codebook/",
            {
                'parent_id': codebook_id,
                'questions':codebookModel.getCodebookJson(),
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            function(response){                
                //! Need error checking for failed responses.
                location.href = '/codebook/'+response._id;
            }
        );
    });
});
</script>
{% endblock %}

{% block breadcrumbs %}
<div class="container">
<ul class="breadcrumb">
  <li>
    <a href="/shared-resources/#codebooks">Codebooks</a> <span class="divider">/</span>
  </li>
  <li>
    <a href="#">{{codebook.name}} ({{codebook.version}})</a></span>
  </li>
</ul>
</div>
{% endblock %}

{% block doc_classes %}
    span3
    well
    offset3
{% endblock %}

{% block title %}
<!--<form method="POST" action="/ajax/save-codebook/">-->
    <a class="btn btn-inverse open-modal rightside">Edit codebook info</a>
    {% include "forms/edit-codebook.htm" %}
    <h3>{{codebook.name}} ({{codebook.version}})</h3>
<!--</form>-->
{% endblock %}

{% block document %}
<!-- --- Codebook --- -->
<!--
<div id="loading-msg">
    <img class="tb-loading" src="{{ STATIC_URL }}ajax-loader.gif"></img>
    <p>Loading codebook...</p>
</div>
-->
<div id="codebook" data-bind="template: { name: 'question-template', foreach: questions }"></div>
{% endblock %}

{% block control %}
<h4>Codebook</h4>
<strong>Name</strong>
<p>{{ codebook.name }}</p>

<strong>Description</strong>
<p>{{ codebook.description }}</p>

<strong>Version</strong>
<p>{{ codebook.version }}</p>




<!--
      <dl class="dl-horizontal">
        <dt>version</dt><dd>{{ codebook.version }}&nbsp;</dd>
        <dt>previous version</dt><dd>{{ codebook.parent }}&nbsp;</dd>
        <dt>has </dt><dd>Gong&nbsp;</dd>
        <dt>email</dt><dd>agong@umich.edu&nbsp;</dd>
           </dl>
-->
   

<!--
      <hr/>
      <div id="impexpControls">
          <a class="btn" id="export-json"><i class="icon-download"></i> Export Json</a>
          <a class="btn" id="export-html"><i class="icon-download"></i> Export HTML</a>
      </div>
-->
     <button id="save-codebook" class="btn btn-primary rightside" type="submit">Save changes</button>
    <h4>Question</h4>
  
        <div id="questionControls"></div>
        <hr/>
        <div id="sequenceControls" style="text-align:center">
            <button id="add_control"><span class="control icon-plus"></span></button>
            <button id="del_control"><span class="control icon-minus"></span></button>
            <button id="up_control"><span class="control icon-arrow-up"></span></button>
            <button id="down_control"><span class="control icon-arrow-down"></span></button>
        </div>
   </div>
  </div>
</div>
{% endblock %}

